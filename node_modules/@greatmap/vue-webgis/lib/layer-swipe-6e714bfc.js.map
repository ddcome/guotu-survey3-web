{"version":3,"file":"layer-swipe-6e714bfc.js","sources":["../src/gis/core/modules/layer-swipe.js"],"sourcesContent":["/**\n * 卷帘功能\n */\nimport ToggleActive from '../common/toggle-active';\nimport { unByKey } from 'ol/Observable';\n\nexport default class LayerSwipe extends ToggleActive {\n  _value = 50;\n  _map;\n  _olMap;\n  _layer;\n  _type; // vertical/horizontal\n  _listener = {\n    precompose: null,\n    postcompose: null\n  };\n  _eventHub;\n\n  constructor(map) {\n    super();\n\n    this._map = map;\n    this._olMap = map.olMap;\n    this._eventHub = map.eventHub;\n\n    this._restart = this._restart.bind(this);\n    this._rectangleClip = this._rectangleClip.bind(this);\n  }\n\n  changeType(type) {\n    this._type = type;\n    this._restart();\n  }\n\n  // 修改卷帘值 0 - 100\n  changeValue(value) {\n    if (value < 0 || value > 100) {\n      value = value < 0 ? 0 : 100;\n    }\n    this._value = value;\n    this._olMap.render();\n  }\n\n  // 激活\n  activateHandle(type = this._type || 'vertical') {\n    this._type = type;\n\n    this._updateLayer();\n\n    // 监听 precompose/postcompose 事件\n    this._listener.precompose = this._layer.on(\n      'precompose',\n      this._rectangleClip\n    );\n    this._listener.postcompose = this._layer.on('postcompose', (event) => {\n      const ctx = event.context;\n      ctx.restore();\n    });\n\n    this._eventHub.on('layerChange', this._restart);\n  }\n\n  // 关闭\n  deactivateHandle() {\n    this._layer = null; // unset\n\n    // 销毁事件\n    const listener = this._listener;\n    Object.keys(listener).forEach((key) => {\n      unByKey(listener[key]);\n      listener[key] = null;\n    });\n\n    // 重置地图的渲染\n    this._olMap.render();\n\n    this._eventHub.off('layerChange', this._restart);\n  }\n\n  /**\n   * 更新卷帘的图层\n   * @private\n   */\n  _updateLayer = () => {\n    const map = this._map;\n    const firstLayer = map.getTopVisibleLayer();\n    if (firstLayer) {\n      this._layer = map.getOlLayer(firstLayer.id)[0];\n    }\n  };\n\n  /**\n   * 重置视图\n   * @private\n   */\n  _restart() {\n    this.toggleActive(true);\n  }\n\n  /**\n   * 创建卷帘形状\n   * @param event 图层渲染事件 precompose 的 event 对象\n   * @private\n   */\n  _rectangleClip(event) {\n    const type = this._type;\n    const ctx = event.context;\n    const canvas = ctx.canvas;\n    const { width: canvasWidth, height: canvasHeight } = canvas;\n    const percent = this._value / 100;\n    let x = 0,\n      y = 0,\n      width = 0,\n      height = 0;\n    if (type === 'vertical') {\n      width = canvasWidth * percent;\n      height = canvasHeight;\n    } else if (type === 'horizontal') {\n      width = canvasWidth;\n      height = canvasHeight * percent;\n      y = canvasHeight - height;\n    }\n\n    ctx.save();\n    ctx.beginPath();\n    ctx.rect(x, y, width, height);\n    ctx.clip();\n  }\n}\n"],"names":["LayerSwipe","map","precompose","postcompose","_map","firstLayer","getTopVisibleLayer","_layer","getOlLayer","id","_olMap","olMap","_eventHub","eventHub","_restart","bind","_rectangleClip","type","_type","value","_value","render","_updateLayer","_listener","on","event","ctx","context","restore","listener","Object","keys","forEach","key","unByKey","off","toggleActive","canvas","canvasWidth","width","canvasHeight","height","percent","x","y","save","beginPath","rect","clip","ToggleActive"],"mappings":"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"}