{"version":3,"file":"chunk-fc6359dc.js","sources":["../src/gis/api/analysis-service.js","../src/gis/core/common/base-analysis.js"],"sourcesContent":["import request from '../utils/request';\nimport { SERVER_CONFIG } from '../config/server';\n\nconst superDataPath = SERVER_CONFIG.superDataPath;\n\n/**\n * 创建服务\n * @param {String} name 服务名称\n * @returns {Promise}\n */\nexport function createAnalysisService(name) {\n  return request({\n    url: `/portal/sharing/rest/content/users/admin/createService`,\n    method: 'post',\n    data: {\n      f: 'json',\n      createParameters: JSON.stringify({\n        currentVersion: 10.2,\n        serviceDescription: '',\n        hasVersionedData: false,\n        supportsDisconnectedEditing: false,\n        hasStaticData: true,\n        maxRecordCount: 2000,\n        supportedQueryFormats: 'JSON',\n        capabilities: 'Query',\n        description: '',\n        copyrightText: '',\n        allowGeometryUpdates: false,\n        syncEnabled: false,\n        editorTrackingInfo: {\n          enableEditorTracking: false,\n          enableOwnershipAccessControl: false,\n          allowOthersToUpdate: true,\n          allowOthersToDelete: true\n        },\n        xssPreventionInfo: {\n          xssPreventionEnabled: true,\n          xssPreventionRule: 'InputOnly',\n          xssInputRule: 'rejectInvalid'\n        },\n        tables: [],\n        name,\n        options: { dataSourceType: 'spatiotemporal' }\n      }),\n      outputType: 'featureService'\n    },\n    analysisToken: true\n  });\n}\n\n/**\n * 创建缓冲区分析\n * @param {String} serviceUrl 服务 URL，创建服务返回\n * @param {String} serviceId 服务 ID，创建服务返回\n * @param {Array} extent 范围\n * @param {Number} wkid 参考系 ID\n * @param {Number} distance 缓冲距离\n * @param {String} name buffer 服务名称\n * @param {String} serviceCode 服务代码，例如 X620100DC2019GXZQ\n * @returns {Promise}\n */\nexport function createBuffersAnalysis({\n  serviceUrl,\n  serviceId,\n  extent,\n  wkid,\n  distance,\n  name,\n  serviceCode\n}) {\n  return request({\n    url: `/server/rest/services/System/GeoAnalyticsTools/GPServer/CreateBuffers/submitJob`,\n    method: 'post',\n    data: {\n      f: 'json',\n      inputLayer: JSON.stringify({\n        url: `${\n          SERVER_CONFIG.arcgisOrigin\n        }/server/rest/services/DataStoreCatalogs/${superDataPath}/BigDataCatalogServer/${serviceCode}`,\n        name: `${superDataPath}-${serviceCode}`\n      }),\n      distance: distance || 10,\n      distanceUnit: 'Meters',\n      method: 'Geodesic',\n      dissolveOption: 'None',\n      OutputName: JSON.stringify({\n        serviceProperties: {\n          name: name,\n          serviceUrl,\n          itemProperties: {\n            itemId: serviceId\n          }\n        }\n      }),\n      context: JSON.stringify({\n        extent: {\n          xmin: extent[0],\n          ymin: extent[1],\n          xmax: extent[2],\n          ymax: extent[3],\n          spatialReference: {\n            wkid,\n            latestWkid: wkid\n          }\n        },\n        outSR: {\n          spatialReference: {\n            wkid\n          }\n        }\n      })\n    },\n    analysisToken: true\n  });\n}\n\n/**\n * 创建叠加分析\n * @param {String} serviceUrl 服务 URL，创建服务返回\n * @param {String} serviceId 服务 ID，创建服务返回\n * @param {String} name overlay 服务名称\n * @param {Object} inputLayer 输入图层\n * @param {Object} overlayLayer 叠加图层\n * @param {String} [overlayType] 叠加图层\n * @returns {Promise}\n */\nexport function createOverlayAnalysis({\n  serviceUrl,\n  serviceId,\n  name,\n  inputLayer,\n  overlayLayer,\n  overlayType = 'Intersect'\n}) {\n  return request({\n    url: `/server/rest/services/System/GeoAnalyticsTools/GPServer/OverlayLayers/submitJob`,\n    method: 'post',\n    data: {\n      f: 'json',\n      inputLayer: JSON.stringify(inputLayer),\n      overlayLayer: JSON.stringify(overlayLayer),\n      overlayType,\n      dissolveOption: 'None',\n      OutputName: JSON.stringify({\n        serviceProperties: {\n          name: name,\n          serviceUrl,\n          itemProperties: {\n            itemId: serviceId\n          }\n        }\n      })\n    },\n    analysisToken: true\n  });\n}\n\n/**\n * 创建汇总分析\n * @param {String} serviceUrl 服务 URL，创建服务返回\n * @param {String} serviceId 服务 ID，创建服务返回\n * @param {String} name summary 服务名称\n * @param {Object} inputLayer 输入图层\n * @return {Promise}\n */\nexport function createSummaryAnalysis({\n  serviceUrl,\n  serviceId,\n  name,\n  inputLayer\n}) {\n  return request({\n    url:\n      '/server/rest/services/System/GeoAnalyticsTools/getAnalysisProgress/SummarizeAttributes/submitJob',\n    method: 'post',\n    data: {\n      f: 'json',\n      inputLayer: JSON.stringify(inputLayer),\n      fields: 'DLBM_overlay,DLMC_overlay,ZLDWDM_overlay,ZLDWMC_overlay',\n      summaryFields: JSON.stringify([\n        {\n          statisticType: 'SUM',\n          onStatisticField: 'TBDLMJ_overlay'\n        }\n      ]),\n      OutputName: JSON.stringify({\n        serviceProperties: {\n          name,\n          serviceUrl,\n          itemProperties: {\n            itemId: serviceId\n          }\n        }\n      })\n    },\n    analysisToken: true\n  });\n}\n\n/**\n * 获取分析进度\n * @param {String} name 服务名称\n * @param {String} id jobID\n * @returns {Promise}\n */\nexport function getAnalysisProgress(name, id) {\n  return request({\n    url: `/server/rest/services/System/GeoAnalyticsTools/GPServer/${name}/jobs/${id}`,\n    params: {\n      f: 'json'\n    },\n    analysisToken: true\n  });\n}\n\n/**\n * 获取分析结果（features）\n * @param {String} name 服务名称\n * @param {String} id 参考系 ID\n * @returns {Promise}\n */\nexport function getAnalysisResult(name, id) {\n  return request({\n    url: `/server/rest/services/Hosted/${name}/FeatureServer/0/query`,\n    method: 'post',\n    data: {\n      where: '1=1',\n      returnGeometry: true,\n      outFields: '*',\n      outSR: id,\n      f: 'json',\n      objectIds: '',\n      returnDistinctValues: '',\n      orderByFields: ''\n    }\n  });\n}\n","import { errorMessage } from '../../../utils/error-handler';\nimport GISEvent from '../common/gis-event';\nimport { getAnalysisProgress } from '../../api/analysis-service';\nimport { checkValidArray } from '../../../utils/check-array';\n\n/**\n * 基础分析类\n */\nexport default class BaseAnalysis extends GISEvent {\n  _intervalTime = 1500;\n  _vectorSource;\n  _map;\n\n  constructor(map) {\n    super('next');\n\n    this._vectorSource = map.vectorSource;\n    this._map = map;\n  }\n\n  /**\n   * 获取分析进度\n   * @description\n   * 根据 `intervalTime` 事件轮询获取分析进度。\n   * @param {String} name 服务名称\n   * @param {String} id jobID\n   * @return {Promise}\n   */\n  getProgress(name, id) {\n    return new Promise((resolve, reject) => {\n      const _this = this;\n      (function polling() {\n        getAnalysisProgress(name, id).then(\n          /** @param {Object<string, *>} res */ (res) => {\n            const status = res ? res.jobStatus : '';\n            if (status === 'esriJobSucceeded') {\n              resolve(res);\n            } else if (status !== 'esriJobFailed') {\n              setTimeout(() => polling(), _this._intervalTime);\n\n              // 执行进度回调\n              if (checkValidArray(res.messages)) {\n                _this.dispatch('next', res.messages && res.messages.pop());\n              }\n            } else {\n              errorMessage(res || res.message);\n              reject(res);\n            }\n          },\n          (error) => {\n            errorMessage(error || error.message);\n            reject(error);\n          }\n        );\n      })();\n    });\n  }\n}\n"],"names":["superDataPath","SERVER_CONFIG","createAnalysisService","name","request","url","method","data","f","createParameters","JSON","stringify","currentVersion","serviceDescription","hasVersionedData","supportsDisconnectedEditing","hasStaticData","maxRecordCount","supportedQueryFormats","capabilities","description","copyrightText","allowGeometryUpdates","syncEnabled","editorTrackingInfo","enableEditorTracking","enableOwnershipAccessControl","allowOthersToUpdate","allowOthersToDelete","xssPreventionInfo","xssPreventionEnabled","xssPreventionRule","xssInputRule","tables","options","dataSourceType","outputType","analysisToken","createBuffersAnalysis","serviceUrl","serviceId","extent","wkid","distance","serviceCode","inputLayer","arcgisOrigin","distanceUnit","dissolveOption","OutputName","serviceProperties","itemProperties","itemId","context","xmin","ymin","xmax","ymax","spatialReference","latestWkid","outSR","createOverlayAnalysis","overlayLayer","overlayType","createSummaryAnalysis","fields","summaryFields","statisticType","onStatisticField","getAnalysisProgress","id","params","getAnalysisResult","where","returnGeometry","outFields","objectIds","returnDistinctValues","orderByFields","BaseAnalysis","map","_vectorSource","vectorSource","_map","Promise","resolve","reject","_this","polling","then","res","status","jobStatus","setTimeout","_intervalTime","checkValidArray","messages","dispatch","pop","errorMessage","message","error","GISEvent"],"mappings":"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"}