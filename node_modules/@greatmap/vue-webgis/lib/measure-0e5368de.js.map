{"version":3,"file":"measure-0e5368de.js","sources":["../src/gis/core/modules/measure.js"],"sourcesContent":["import { unByKey } from 'ol/Observable.js';\nimport Overlay from 'ol/Overlay.js';\nimport LineString from 'ol/geom/LineString';\nimport Polygon from 'ol/geom/Polygon';\n\nimport ToggleActive from '../common/toggle-active';\n\n/**\n * 测量（线/多边形）\n */\nexport default class Measure extends ToggleActive {\n  _map;\n  _olMap;\n  _drawInteraction;\n  _measureTooltips = []; // all tooltips\n\n  constructor(map) {\n    super();\n\n    this._map = map;\n    this._olMap = map.olMap;\n    this._drawInteraction = map.interactions.draw;\n  }\n\n  /**\n   * Activate\n   * @param {String} type line/area\n   */\n  activateHandle(type) {\n    // 在绘制开始时添加\n    // this._createMeasureTooltip();\n\n    this._addInteraction(type);\n  }\n\n  /**\n   * Deactivate\n   */\n  deactivateHandle() {\n    // remove element（不清理）\n    // this._removeMeasureTooltip();\n\n    this._removeInteraction();\n  }\n\n  /**\n   * Add interaction\n   * @param {String} type LineString/Polygon\n   * @private\n   */\n  _addInteraction(type) {\n    // 激活交互\n    this._drawInteraction.toggleActive(true, type);\n\n    let listener; // 监听事件\n    let measureTooltip;\n    let measureTooltipElement;\n\n    this._drawInteraction.on('drawstart', (resultData) => {\n      const measureTooltipObj = this._createMeasureTooltip();\n      measureTooltip = measureTooltipObj.measureTooltip;\n      measureTooltipElement = measureTooltipObj.measureTooltipElement;\n\n      // 监听 geometry 的变化\n      let tooltipCoordinate;\n      listener = resultData.geometry.on('change', (evt) => {\n        const geom = evt.target;\n        let output = this._map.formatGeometrySize(geom).str;\n        if (geom instanceof Polygon) {\n          tooltipCoordinate = geom.getInteriorPoint().getCoordinates();\n        } else if (geom instanceof LineString) {\n          tooltipCoordinate = geom.getLastCoordinate();\n        }\n        measureTooltipElement.innerHTML = output;\n        measureTooltip.setPosition(tooltipCoordinate);\n      });\n    });\n    this._drawInteraction.on('drawend', () => {\n      measureTooltip.setOffset([0, -7]);\n\n      // 销毁引用与监听\n      measureTooltip = null;\n      measureTooltipElement = null;\n      unByKey(listener);\n    });\n  }\n\n  /**\n   * Remove\n   * @private\n   */\n  _removeInteraction() {\n    // 关闭交互\n    this._drawInteraction.toggleActive(false);\n\n    // 取消监听事件\n    this._drawInteraction.offAll();\n  }\n\n  /**\n   * Creates a new measure tooltip\n   * @private\n   */\n  _createMeasureTooltip() {\n    const measureTooltipElement = document.createElement('div');\n    measureTooltipElement.className =\n      'webgis-measure-tooltip webgis-measure-tooltip-measure';\n    const measureTooltip = new Overlay({\n      element: measureTooltipElement,\n      offset: [0, -15],\n      positioning: 'bottom-center'\n    });\n\n    // save measure record\n    this._measureTooltips.push(measureTooltip);\n\n    this._olMap.addOverlay(measureTooltip);\n\n    return {\n      measureTooltip,\n      measureTooltipElement\n    };\n  }\n\n  /**\n   * Remove helpTooltip\n   * @private\n   */\n  _removeMeasureTooltip() {\n    this._measureTooltips.forEach((item) => this._olMap.removeOverlay(item));\n    this._measureTooltips = [];\n  }\n}\n"],"names":["Measure","map","_map","_olMap","olMap","_drawInteraction","interactions","draw","type","_addInteraction","_removeInteraction","toggleActive","listener","measureTooltip","measureTooltipElement","on","resultData","measureTooltipObj","_createMeasureTooltip","tooltipCoordinate","geometry","evt","geom","target","output","formatGeometrySize","str","Polygon","getInteriorPoint","getCoordinates","LineString","getLastCoordinate","innerHTML","setPosition","setOffset","unByKey","offAll","document","createElement","className","Overlay","element","offset","positioning","_measureTooltips","push","addOverlay","forEach","item","removeOverlay","ToggleActive"],"mappings":";;;;;;;;;;;;;;;;;;;IAUqBA;;;;;mBAMPC,GAAZ,EAAiB;;;;;;;;;;;;;uEAFE,EAEF;;UAGVC,IAAL,GAAYD,GAAZ;UACKE,MAAL,GAAcF,GAAG,CAACG,KAAlB;UACKC,gBAAL,GAAwBJ,GAAG,CAACK,YAAJ,CAAiBC,IAAzC;;;;;;mCAOaC,MAAM;WAIdC,eAAL,CAAqBD,IAArB;;;;uCAMiB;WAIZE,kBAAL;;;;oCAQcF,MAAM;;;WAEfH,gBAAL,CAAsBM,YAAtB,CAAmC,IAAnC,EAAyCH,IAAzC;;UAEII,QAAJ;UACIC,cAAJ;UACIC,qBAAJ;;WAEKT,gBAAL,CAAsBU,EAAtB,CAAyB,WAAzB,EAAsC,UAACC,UAAD,EAAgB;YAC9CC,iBAAiB,GAAG,MAAI,CAACC,qBAAL,EAA1B;;QACAL,cAAc,GAAGI,iBAAiB,CAACJ,cAAnC;QACAC,qBAAqB,GAAGG,iBAAiB,CAACH,qBAA1C;YAGIK,iBAAJ;QACAP,QAAQ,GAAGI,UAAU,CAACI,QAAX,CAAoBL,EAApB,CAAuB,QAAvB,EAAiC,UAACM,GAAD,EAAS;cAC7CC,IAAI,GAAGD,GAAG,CAACE,MAAjB;;cACIC,MAAM,GAAG,MAAI,CAACtB,IAAL,CAAUuB,kBAAV,CAA6BH,IAA7B,EAAmCI,GAAhD;;cACIJ,IAAI,YAAYK,OAApB,EAA6B;YAC3BR,iBAAiB,GAAGG,IAAI,CAACM,gBAAL,GAAwBC,cAAxB,EAApB;WADF,MAEO,IAAIP,IAAI,YAAYQ,UAApB,EAAgC;YACrCX,iBAAiB,GAAGG,IAAI,CAACS,iBAAL,EAApB;;;UAEFjB,qBAAqB,CAACkB,SAAtB,GAAkCR,MAAlC;UACAX,cAAc,CAACoB,WAAf,CAA2Bd,iBAA3B;SATS,CAAX;OAPF;;WAmBKd,gBAAL,CAAsBU,EAAtB,CAAyB,SAAzB,EAAoC,YAAM;QACxCF,cAAc,CAACqB,SAAf,CAAyB,CAAC,CAAD,EAAI,CAAC,CAAL,CAAzB;QAGArB,cAAc,GAAG,IAAjB;QACAC,qBAAqB,GAAG,IAAxB;QACAqB,OAAO,CAACvB,QAAD,CAAP;OANF;;;;yCAcmB;WAEdP,gBAAL,CAAsBM,YAAtB,CAAmC,KAAnC;;WAGKN,gBAAL,CAAsB+B,MAAtB;;;;4CAOsB;UAChBtB,qBAAqB,GAAGuB,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAA9B;MACAxB,qBAAqB,CAACyB,SAAtB,GACE,uDADF;UAEM1B,cAAc,GAAG,IAAI2B,OAAJ,CAAY;QACjCC,OAAO,EAAE3B,qBADwB;QAEjC4B,MAAM,EAAE,CAAC,CAAD,EAAI,CAAC,EAAL,CAFyB;QAGjCC,WAAW,EAAE;OAHQ,CAAvB;;WAOKC,gBAAL,CAAsBC,IAAtB,CAA2BhC,cAA3B;;WAEKV,MAAL,CAAY2C,UAAZ,CAAuBjC,cAAvB;;aAEO;QACLA,cAAc,EAAdA,cADK;QAELC,qBAAqB,EAArBA;OAFF;;;;4CAUsB;;;WACjB8B,gBAAL,CAAsBG,OAAtB,CAA8B,UAACC,IAAD;eAAU,MAAI,CAAC7C,MAAL,CAAY8C,aAAZ,CAA0BD,IAA1B,CAAV;OAA9B;;WACKJ,gBAAL,GAAwB,EAAxB;;;;;EAxHiCM;;;;"}