{"version":3,"file":"chunk-81d749a9.js","sources":["../src/gis/api/token.js","../src/gis/utils/request.js","../src/utils/check-array.js"],"sourcesContent":["import { analysisAuth, gisServerAuth } from '../utils/gis-server-auth';\nimport { SERVER_CONFIG } from '../config/server';\nimport request from '../utils/request';\n\n/**\n * 获取查询用的 token\n * @description\n * process 作用为防重复请求。\n * @returns {Promise}\n */\nexport function getToken() {\n  return (getToken.process = getToken.process\n    ? getToken.process\n    : createToken().then((res) => {\n        getToken.process = null;\n        if (res && res.token) {\n          gisServerAuth.setToken(res);\n        }\n      }));\n}\n\n/**\n * 获取分析用的 token\n * @description\n * process 作用为防重复请求。\n * @returns {Promise}\n */\nexport function getAnalysisToken() {\n  return (createToken.process = createToken.process\n    ? createToken.process\n    : createToken(SERVER_CONFIG.host).then((res) => {\n        createToken.process = null;\n        if (res && res.token) {\n          analysisAuth.setToken(res);\n        }\n      }));\n}\n\n/**\n * 创建 token\n * @params {String} referer 生成 token 的 referer 参数\n * 1. referer: serverUrl 生成查询 token\n * 2. referer: host 生成分析 token\n */\nfunction createToken(referer = SERVER_CONFIG.host) {\n  return request({\n    url: SERVER_CONFIG.arcgisToken,\n    method: 'post',\n    data: {\n      username: SERVER_CONFIG.arcgisUsername,\n      password: SERVER_CONFIG.arcgisPassword,\n      referer,\n      client: 'referer',\n      f: 'json'\n    }\n  });\n}\n","import axios from 'axios';\nimport stringify from 'qs/lib/stringify';\n\nimport { analysisAuth, gisServerAuth } from './gis-server-auth';\nimport { getAnalysisToken, getToken } from '../api/token';\nimport { SERVER_CONFIG } from '../config/server';\nimport { errorMessage } from '../../utils/error-handler';\n\nexport default commonRequest;\n\n/**\n * 创建 axios 服务实例\n * @description\n * 该方法所需的参数如下：\n * @param {String} url 请求的 url\n * @param {String} method 请求方式 `get/post`\n * @param {Object} data post 请求的参数\n * @param {Object} params get 请求的参数\n * @param {Boolean} analysisToken 是否需要分析用的 token，否则为普通的 token\n */\nconst axiosInstance = axios.create({\n  // withCredentials: true,\n  timeout: 20000\n});\n\n// 请求拦截\naxiosInstance.interceptors.request.use(\n  (config) => {\n    // 设置 baseURL\n    if (!config.baseURL) {\n      config.baseURL = SERVER_CONFIG.arcgis;\n    }\n\n    // 设置 token\n    if (!config.url.includes('/generateToken')) {\n      config = addToken(config);\n    } else {\n      config = postDataTransform(config);\n    }\n\n    return config;\n  },\n  (error) => {\n    errorMessage(error);\n    return Promise.reject(error);\n  }\n);\n\n// 响应拦截\naxiosInstance.interceptors.response.use(\n  (response) => {\n    const data = response.data;\n    if (!data || data.error) {\n      if (data.error === 'TOKEN INVALID') {\n        return autoGetToken(response.config.analysisToken);\n      } else {\n        return Promise.reject(data);\n      }\n    } else {\n      return data;\n    }\n  },\n  (error) => {\n    errorMessage(error);\n    return Promise.reject(error);\n  }\n);\n\n/**\n * 通用的请求服务\n * @param {AxiosRequestConfig} config\n * @return {Promise<AxiosResponse>}\n */\nfunction commonRequest(config) {\n  return axiosInstance(config).catch((error) => {\n    errorMessage(error);\n    return Promise.reject(error);\n  });\n}\n\n/**\n * 将 token 添加到请求参数中\n * @param {Object} config 请求配置\n * @returns {Promise}\n */\nfunction addToken(config) {\n  return autoGetToken(config.analysisToken).then((token) => {\n    if (config.method === 'post') {\n      config.data = config.data || {};\n      config.data.token = token;\n      postDataTransform(config);\n    } else if (config.method === 'get') {\n      config.params = config.params || {};\n      config.params.token = token;\n    }\n    return config;\n  });\n}\n\n/**\n * post 参数转换\n * @param {Object} config 请求配置\n */\nfunction postDataTransform(config) {\n  if (config.method === 'post') {\n    config.headers['Content-Type'] = 'application/x-www-form-urlencoded';\n    config.data = stringify(config.data);\n  }\n  return config;\n}\n\n// 自动获取 token\nfunction autoGetToken(analysisToken) {\n  // 是否为分析用的 token\n  const isAnalysisToken = analysisToken === true;\n  const token = (isAnalysisToken ? analysisAuth : gisServerAuth).getToken();\n\n  // 判断 token 是否存在，不存在发送获取 token 的请求\n  if (token) {\n    return Promise.resolve(token);\n  } else {\n    return (isAnalysisToken ? getAnalysisToken() : getToken()).then(() =>\n      autoGetToken(analysisToken)\n    );\n  }\n}\n","/**\n * 校验数组是否有效\n * @param {*} data\n * @return {boolean}\n */\nexport function checkValidArray(data) {\n  return Array.isArray(data) && data.length;\n}\n"],"names":["getToken","process","createToken","then","res","token","gisServerAuth","setToken","getAnalysisToken","SERVER_CONFIG","host","analysisAuth","referer","request","url","arcgisToken","method","data","username","arcgisUsername","password","arcgisPassword","client","f","axiosInstance","axios","create","timeout","interceptors","use","config","baseURL","arcgis","includes","addToken","postDataTransform","error","errorMessage","Promise","reject","response","autoGetToken","analysisToken","commonRequest","catch","params","headers","stringify","isAnalysisToken","resolve","checkValidArray","Array","isArray","length"],"mappings":"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"}