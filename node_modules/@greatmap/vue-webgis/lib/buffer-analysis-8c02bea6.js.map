{"version":3,"file":"buffer-analysis-8c02bea6.js","sources":["../src/gis/api/modules/buffer-analysis.js","../src/gis/core/modules/buffer-analysis.js"],"sourcesContent":["import {\n  createOverlayAnalysis as baseCreateOverlayAnalysis,\n  createSummaryAnalysis as baseCreateSummaryAnalysis\n} from '../analysis-service';\nimport { SERVER_CONFIG } from '../../config/server';\n\nconst arcgisOrigin = SERVER_CONFIG.arcgisOrigin;\nconst superDataPath = SERVER_CONFIG.superDataPath;\n\n/**\n * 创建叠加分析\n * @param {String} serviceUrl 服务 URL，创建服务返回\n * @param {String} serviceId 服务 ID，创建服务返回\n * @param {String} name overlay 服务名称\n * @param {String} bufferName buffer 服务名称\n * @param {String} serviceCode 服务代码，例如 X620100DC2019GXZQ\n * @returns {Promise}\n */\nexport function createOverlayAnalysis({\n  serviceUrl,\n  serviceId,\n  name,\n  bufferName,\n  serviceCode\n}) {\n  return baseCreateOverlayAnalysis({\n    serviceUrl,\n    serviceId,\n    name,\n    inputLayer: {\n      url: `${arcgisOrigin}/server/rest/services/DataStoreCatalogs/${superDataPath}/BigDataCatalogServer/${serviceCode}`,\n      name: `${superDataPath}-${serviceCode}`\n    },\n    overlayLayer: {\n      url: `${arcgisOrigin}/server/rest/services/Hosted/${bufferName}/FeatureServer/0`,\n      name: bufferName\n    }\n  });\n}\n\n/**\n * 创建汇总分析\n * @param {String} serviceUrl 服务 URL，创建服务返回\n * @param {String} serviceId 服务 ID，创建服务返回\n * @param {String} name 汇总分析名称\n * @param {String} overlayName 叠加分析名称\n * @return {Promise}\n */\nexport function createSummaryAnalysis({\n  serviceUrl,\n  serviceId,\n  name,\n  overlayName\n}) {\n  return baseCreateSummaryAnalysis({\n    serviceUrl,\n    serviceId,\n    name,\n    inputLayer: {\n      url: `${arcgisOrigin}/server/rest/services/Hosted/${overlayName}/FeatureServer/0`\n    }\n  });\n}\n","import classMixin from '../../utils/class-mixin';\nimport ToggleActive from '../common/toggle-active';\nimport {\n  createBuffersAnalysis,\n  createAnalysisService,\n  getAnalysisResult\n} from '../../api/analysis-service';\nimport {\n  createOverlayAnalysis,\n  createSummaryAnalysis\n} from '../../api/modules/buffer-analysis';\nimport BaseAnalysis from '../common/base-analysis';\n\n/**\n * 缓冲区分析\n *\n * @extends {BufferAnalysis,ToggleActive}\n *\n * @events 支持的事件\n * - next 分析进度 +1 回调，返回进度消息\n */\nexport default class BufferAnalysis extends classMixin(\n  BaseAnalysis,\n  ToggleActive\n) {\n  _wkid;\n  _map;\n\n  constructor(map) {\n    super(map);\n\n    this._wkid = map.mapConfig.wkid;\n    this._map = map;\n  }\n\n  /**\n   * 执行分析\n   * @param {Array} extent 分析范围\n   * @param {Number} distance 缓冲距离\n   * @returns {Promise}\n   */\n  doAnalysis(extent, distance) {\n    const dateId = Date.now();\n    const bufferName = 'buffer_cs' + dateId;\n    const overlayName = 'overlay_cs' + dateId;\n    const summaryName = 'summary_cs' + dateId;\n    const serviceCode = this._map.getTopVisibleLayer().id;\n\n    // 执行缓冲与叠加分析\n    return this._bufferAnalysis(serviceCode, bufferName, extent, distance).then(\n      () => {\n        return this._overlayAnalysis(serviceCode, overlayName, bufferName).then(\n          () => {\n            return this._summaryAnalysis(\n              serviceCode,\n              summaryName,\n              overlayName\n            ).then(() => {\n              return getAnalysisResult(summaryName, this._wkid).then((res) => {\n                this._map.interactions.zoom.toFeatures(\n                  this._map.renderFeatureData(res)\n                );\n                return res;\n              });\n            });\n          }\n        );\n      }\n    );\n  }\n\n  /**\n   * 缓冲分析\n   * @param {String} serviceCode 图层服务 ID\n   * @param {String} bufferName 缓冲分析名称\n   * @param {Array} extent 分析范围\n   * @param {Number} distance 缓冲距离\n   * @returns {Promise}\n   * @private\n   */\n  _bufferAnalysis(serviceCode, bufferName, extent, distance) {\n    return createAnalysisService(bufferName).then((res) => {\n      return createBuffersAnalysis({\n        serviceUrl: res.serviceurl,\n        serviceId: res.itemId,\n        extent,\n        wkid: this._wkid,\n        distance,\n        name: bufferName,\n        serviceCode\n      }).then(\n        /** @param {Object<string, *>} res */ (res) => {\n          return this.getProgress('CreateBuffers', res.jobId);\n        }\n      );\n    });\n  }\n\n  /**\n   * 叠加分析\n   * @description\n   * 根据缓冲分析进行叠加分析\n   * @param {String} serviceCode 图层服务 ID\n   * @param {String} overlayName 叠加分析名称\n   * @param {String} bufferName 缓冲分析的名称\n   * @returns {Promise}\n   * @private\n   */\n  _overlayAnalysis(serviceCode, overlayName, bufferName) {\n    return createAnalysisService(overlayName).then((res) => {\n      return createOverlayAnalysis({\n        serviceUrl: res.serviceurl,\n        serviceId: res.itemId,\n        name: overlayName,\n        bufferName: bufferName,\n        serviceCode\n      }).then((res) => {\n        return this.getProgress('OverlayLayers', res.jobId);\n      });\n    });\n  }\n\n  /**\n   * 汇总分析\n   * @param {String} serviceCode 图层服务 ID\n   * @param {String} summaryName 汇总分析名称\n   * @param {String} overlayName 叠加分析名称\n   * @return {Promise}\n   * @private\n   */\n  _summaryAnalysis(serviceCode, summaryName, overlayName) {\n    return createAnalysisService(summaryName).then((res) => {\n      return createSummaryAnalysis({\n        name: summaryName,\n        serviceUrl: res.serviceurl,\n        serviceId: res.itemId,\n        overlayName,\n        serviceCode\n      }).then((res) => {\n        return this.getProgress('SummarizeAttributes', res.jobId);\n      });\n    });\n  }\n}\n"],"names":["arcgisOrigin","SERVER_CONFIG","superDataPath","createOverlayAnalysis","serviceUrl","serviceId","name","bufferName","serviceCode","baseCreateOverlayAnalysis","inputLayer","url","overlayLayer","createSummaryAnalysis","overlayName","baseCreateSummaryAnalysis","BufferAnalysis","map","_wkid","mapConfig","wkid","_map","extent","distance","dateId","Date","now","summaryName","getTopVisibleLayer","id","_bufferAnalysis","then","_overlayAnalysis","_summaryAnalysis","getAnalysisResult","res","interactions","zoom","toFeatures","renderFeatureData","createAnalysisService","createBuffersAnalysis","serviceurl","itemId","getProgress","jobId","classMixin","BaseAnalysis","ToggleActive"],"mappings":"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"}