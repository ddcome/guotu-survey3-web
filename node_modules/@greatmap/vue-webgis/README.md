[TOC]

# WebGIS

GreatMap webgis 组件封装。

- [查看详细的开发文档](./docs/README.md)
- [查看完整的功能模块列表](./docs/modules.md)
- [查看更多组件](./docs/components.md)

# 使用

## 安装

```
npm install --save git+ssh://git@192.168.1.44:framework/vue-webgis.git#master
```

## 注册组件（全局方式）：

```js
import Vue from 'vue';
import WebGIS from '@greatmap/vue-webgis';
// 注意：如果你的应用没有使用 element-ui，需要加入下面的 element-ui 资源
// import '@greatmap/vue-webgis/lib/element-ui';

Vue.use(WebGIS); // 组件中使用 `<WebGIS></WebGIS>`
```

## 注册组件（局部方式）：

```vue
<template>
  <WebGIS @init="onInit($event)" />
</template>

<script>
import WebGIS from '@greatmap/vue-webgis';
// 注意：如果你的应用没有使用 element-ui，需要加入下面的 element-ui 资源
// import '@greatmap/vue-webgis/lib/element-ui';

export default {
  components: {
    WebGIS
  },
  methods: {
    // 初始化后返回一个对象，包含 WebGIS 的所有功能
    onInit(webgis) {
      this.webgis = webgis;
    }
  }
};
</script>
```

# 服务地址配置

包括使用到的接口的地址，arcgis 的相关配置。

```
import { updateServerAPI } from '@greatmap/vue-webgis';

// 在渲染 webgis 组件前执行，完整的参数查看下方
updateServerAPI({
  arcgis: 'http://192.168.1.247:6080',
  arcgisQuery: 'http://192.168.1.247:6080',
  arcgisOrigin: 'http://192.168.1.247:6080',
  arcgisToken: 'http://192.168.1.247:6080/arcgis/tokens/generateToken',
  arcgisServiceList: 'http://192.168.1.247:6080/arcgis/admin/services',
  arcgisUsername: 'arcgis',
  arcgisPassword: 'arcgis'
});

/**
 * @typedef {object} ServerAPI
 * @property {string} [host] 域名地址，默认取 location.host
 * @property {string} [arcgis] arcgis 接口地址，例如 http://wh.greatmap.com.cn:16442
 * @property {string} [arcgisQuery] arcgis 查询接口地址，例如 http://wh.greatmap.com.cn:16443
 * @property {string} [arcgisOrigin] arcgis 原始域名，例如 https://gis120.arcgisonline.cn
 * @property {string} [arcgisService] arcgis/service 接口
 * @property {string} [arcgisRestService] arcgis/rest/service 接口
 * @property {string} [superDataPath] arcgis 大数据目录
 * @property {string} [arcgisToken] arcgis 获取 token
 * @property {string} [arcgisServiceList] arcgis 获取服务列表
 * @property {string} [arcgisUsername] arcgis 用户名
 * @property {string} [arcgisPassword] arcgis 密码
 */
```

# 组件 API

## Props

- `modules` : Array，配置地图使用的功能模块，[查看完整的功能模块列表](./docs/modules.md)。
- `showControls` : Boolean，是否展示控件层，默认 true
- `showAside` : Boolean，是否展示 aside （目前仅有图层树内容），默认 false
- `splitScreen` : Boolean，是否展示分屏，默认 false
- `controls` : Array，配置地图使用的控件，默认 `['mousePosition', 'scaleLine']`
- `options` : Object, 地图的选项，目前支持的参数如下：

  | 参数名                          | 类型                     | 说明                                 |
  | ------------------------------- | ------------------------ | ------------------------------------ |
  | `options.serviceCode`           | Array 或 String          | 服务 ID 配置，下方有参考配置         |
  | `options.showLayers`            | Array 或 String          | 展示的图层名配置，下方有参考配置     |
  | `options.aliasMap`              | Object                   | 图层的中文别名对照表，下方有参考配置 |
  | `options.defaultVisibleService` | Object                   | 图层树的排序对象，下方有参考配置     |
  | `options.epsgConfig`            | Object                   | EPSG 配置，下方有参考配置            |
  | `options.defaultLayerConfig`    | Object                   | 默认图层配置，下方有参考配置         |
  | `options.jurisdictionTreeData`  | Array<{id,name}>         | 辖区数据配置，下方有参考配置         |
  | `options.searchRange`           | Object<{layers, fields}> | 查询范围配置，下方有参考配置         |

> 服务 ID 规则：[地类] - [行政区] - [专题] - [年度] - [比例尺] - [图层]

### 参考配置

```js
const options = {
  // 服务ID配置
  serviceCode: ['X621122TDXZ2019G'],

  // 地图展示的图层名配置
  showLayers: ['X621122TDXZ2019GXZQ'],

  // 图层的中文别名对照表
  aliasMap: {
    land: { X: '现状' },
    region: { '621122': '陇西县' },
    scale: { G: '1:10000' },
    special: { TDLYXZ: '土地利用现状' },
    year: { 2017: '2017' },
    layer: { PZWJSTD: '批准未建设土地' }
  },

  // 图层树的排序对象（通过参数的匹配度来进行图层树的排序）
  // 支持数组类型，数组第一位在图层树的上面
  defaultVisibleService: {
    land: '', // 地类
    region: ['620000', '620001'], // 行政区
    special: '', // 专题
    year: ['2018', '2019'], // 年度
    // scale: '', // 比例尺
    layer: 'XZQ' // 图层
  },

  // EPSG 配置
  epsgConfig: { 'EPSG:4490': '+proj=longlat +ellps=GRS80 +no_defs' },

  // 默认图层配置
  defaultLayerConfig: {
    // wmts/wms 图层类型的临界值
    // 1-3 展示 wmts，3- 展示 wms
    zoomThreshold: 0
  },

  // 辖区数据配置
  jurisdictionTreeData: [{ id: '620000', name: '甘肃省', children: [] }],

  // 查询范围配置
  searchRange: { layers: ['X620000JCDL2019GXZQ'], fields: ['BSM', 'XZQDM'] }
};
```

## Events

- `@init($event)` : \$event Object 地图初始化完成返回的实例对象
- `@init-split-screen($event)` : \$event Object 分屏地图初始化完成返回的实例对象

## 初始化返回对象

### 实例参数

`Map` 生成的实例初始化之后的参数说明。

| 参数名              | 类型   | 说明                                 |
| ------------------- | ------ | ------------------------------------ |
| `id`                | Number | 生成实例的唯一 ID                    |
| `showLayers`        | Array  | 默认展示的图层 ID 集合               |
| `interactions`      | Object | 内置交互功能                         |
| `mapConfig`         | Object | 地图配置项                           |
| `modules`           | Array  | 内置或者按需加载的模块功能           |
| `olMap`             | Object | ol/Map 实例                          |
| `olView`            | Object | ol/View 实例                         |
| `vectorSource`      | Object | ol/source/Vector 实例                |
| `vectorLayer`       | Object | ol/vector/Layer 实例                 |
| `selectInteraction` | Object | ol/interaction/Select 实例           |
| `selectedFeatures`  | Array  | selectInteraction.getFeatures() 对象 |
| `formatEsriJSON`    | Object | ol/format/EsriJSON 实例              |
| `treeLayers`        | Array  | 图层列表                             |
| `treeNodes`         | Array  | 图层树结构                           |
| `eventHub`          | Object | webgis 的事件中心                    |

#### eventHub API 说明

- `on(eventName, callback)` 监听事件，当前支持的事件有
  - `checkChange` 图层树勾选事件，返回勾选的 id，勾选状态
  - `layerChange` showLayers 变更事件，返回变更的 showLayers
  - `clear` 地图的清理事件
- `off(eventName, callback)` 销毁事件
- `offAll()` 销毁所有事件
- `dispatch(eventName)` 触发事件，由地图内部触发，**避免调用**

### 实例方法

- `updateSize(duration)` 更新地图视图

| 参数名     | 类型   | 说明                                   |
| ---------- | ------ | -------------------------------------- |
| `duration` | Number | 持续时间，用于动画中进行过渡式更新大小 |

- `exportImage()` 导出图片

- `toggleCursorStyle(type)` 切换光标样式（原生的光标样式，例如：`type = cursor`）

- `toggleControls(state, controlsName)` 切换地图控件

| 参数名         | 类型    | 说明                             |
| -------------- | ------- | -------------------------------- |
| `state`        | Boolean | 切换状态                         |
| `controlsName` | Array?  | 需要切换的控件，默认切换所有控件 |

- `toggleSelectInteraction(state)` 切换选取要素交互状态

| 参数名  | 类型    | 说明     |
| ------- | ------- | -------- |
| `state` | Boolean | 切换状态 |

- `getLayerInfo(param): Promise<Object>` 获取图层信息

| 参数名                 | 类型              | 说明                                |
| ---------------------- | ----------------- | ----------------------------------- |
| `param.serviceCode`    | String            | 服务地址，例如：X510183TDXZG2017XZQ |
| `param.layerId`        | String            | 图层的 id，例如：0                  |
| `param.epsgNum`        | String            | 参考系，例如：4499                  |
| `param.extent`         | Number[]/Geometry | 4 个坐标点或者几何范围对象          |
| `param.where`          | String            | 查询语句，例如：BSM='123'           |
| `param.returnGeometry` | String            | 是否返回 geometry 数据，默认 true   |
| `param.outFields`      | Boolean           | 输出 fields，例如：'BSM,DLTB'       |

- `getLayerInfoParams(layerId, elseParams)` 获取图层的详情请求参数，返回 `getLayerInfo` 方法的参数

| 参数名       | 类型   | 说明                               |
| ------------ | ------ | ---------------------------------- |
| `layerId`    | String | 图层 ID，例如：X510183TDXZG2017XZQ |
| `elseParams` | Object | 其他参数，例如：{ where: '1=1' }   |

- `getLayerField(layerId)` 获取图层字段，返回 `[{value, label}]` 字段数据数组

| 参数名    | 类型   | 说明                               |
| --------- | ------ | ---------------------------------- |
| `layerId` | String | 图层 ID，例如：X510183TDXZG2017XZQ |

- `getLayerFieldValue(layerId, field)` 获取图层字段值，返回 `[{value, label}]` 字段值数据数组

| 参数名    | 类型   | 说明                               |
| --------- | ------ | ---------------------------------- |
| `layerId` | String | 图层 ID，例如：X510183TDXZG2017XZQ |
| `field`   | String | 图层字段，例如：BSM                |

- `resolveFeatureData(featureData)` 解析要素，返回解析后的 features

| 参数名        | 类型   | 说明                                              |
| ------------- | ------ | ------------------------------------------------- |
| `featureData` | Object | arcgis 返回的要素数据（通过 `getLayerInfo` 获取） |

- `renderFeatureData(featureData)` 渲染要素，会直接渲染到地图上

- `addFeature(feature)` 添加要素

| 参数名    | 类型   | 说明                                                |
| --------- | ------ | --------------------------------------------------- |
| `feature` | Object | arcgis 的要素对象（通过 `resolveFeatureData` 获取） |

- `removeFeature(feature)` 移除要素

| 参数名    | 类型   | 说明                                                |
| --------- | ------ | --------------------------------------------------- |
| `feature` | Object | arcgis 的要素对象（通过 `resolveFeatureData` 获取） |

- `focusFeature(feature)` 聚焦 feature

| 参数名    | 类型   | 说明                                                |
| --------- | ------ | --------------------------------------------------- |
| `feature` | Object | arcgis 的要素对象（通过 `resolveFeatureData` 获取） |

- `searchFeature(options): Promise<{data: Array, features: Array}>` 查询要素

| 参数名             | 类型          | 说明                                       |
| ------------------ | ------------- | ------------------------------------------ |
| `options.geometry` | Geometry      | 几何范围                                   |
| `options.where`    | String        | 查询 SQL 语句，例如：`BSM = '19'`          |
| `options.layerIds` | Array<String> | 查询图层 ID，例如：['X620000JCDL2019GXZQ'] |

- `selectFeature(feature)` 选中要素

| 参数名    | 类型   | 说明                                                |
| --------- | ------ | --------------------------------------------------- |
| `feature` | Object | arcgis 的要素对象（通过 `resolveFeatureData` 获取） |

- `setFeatureStyle(feature, options)` 设置要素样式

| 参数名    | 类型              | 说明                                                |
| --------- | ----------------- | --------------------------------------------------- |
| `feature` | Feature/Feature[] | arcgis 的要素对象（通过 `resolveFeatureData` 获取） |
| `options` | {fillStyle}       | 填充样式，参考 ol/style/Style 配置                  |
| `options` | {strokeStyle}     | 线条样式，参考 ol/style/Stroke 配置                 |

- `clearSelectFeature()` 清理选中要素

- `clearFeature()` 清理地图上的要素（包括选中的）

- `clear()` 清理地图上的元素

- `formatGeometryObject(geometryLike)` 获取几何范围对象，返回 `{ geometryType: String, geometry: Object }`

| 参数名         | 类型              | 说明                       |
| -------------- | ----------------- | -------------------------- |
| `geometryLike` | Number[]/Geometry | 范围数组或者 Geometry 对象 |

- `formatGeometrySize(geometry)` 获取几何图形的大小，返回 `{ str: String, num: Number }`

| 参数名     | 类型               | 说明          |
| ---------- | ------------------ | ------------- |
| `geometry` | Polygon/LineString | Geometry 对象 |

- `checkChange(nodeId, checked): void` 切换节点的勾选状态

| 参数名    | 类型                                       | 说明             |
| --------- | ------------------------------------------ | ---------------- |
| `nodeId`  | Array<Number 或 Symbol>或 Number 或 Symbol | 节点 ID          |
| `checked` | Boolean                                    | 节点是否勾选状态 |

- `layerChange(showLayers)` 修改当前展示的图层

| 参数名       | 类型            | 说明    |
| ------------ | --------------- | ------- |
| `showLayers` | Array 或 String | 图层 ID |

- `setLayerOpacity(layerId, opacity)` 设置图层的透明度

| 参数名    | 类型   | 说明           |
| --------- | ------ | -------------- |
| `layerId` | String | 图层 ID        |
| `opacity` | Number | opacity 0 ～ 1 |

- `setLayerSort(layerId, type)` 设置图层的排序

| 参数名      | 类型   | 说明                                    |
| ----------- | ------ | --------------------------------------- |
| `layerId`   | String | 图层 ID                                 |
| `direction` | String | 排序方向 `down` 向下移动，`up` 向上移动 |

## Slots

- `aside` 侧边栏插槽，用于放在 webgis 的左侧的内容（不占地图空间）

# 辅助 Mixins

提供了两套辅助组件注册/注入 webgis 实例的混入对象，便于在组件间进行 webgis 实例的交互。

- webgisProvidePrivate & webgisInjectPrivate 用于单独的 webgis
- webgisProvidePublic & webgisInjectPublic 用于全局的 webgis

使用：

```vue
<template>
  <div>
    <WebGIS @init="initWebgis"></WebGIS>
    <!-- `$webgis` is async load -->
    <el-button @click="$webgis && $webgis.interactions.zoom.change('zoom-in')">
      放大
    </el-button>
  </div>
</template>

<script>
import WebGIS, {
  webgisProvidePrivate,
  webgisInjectPrivate
} from '@greatmap/vue-webgis';

// 用于注册
export const ComponentA = {
  // 用于注册，提供了 `initWebgis(webgis)` 方法
  mixins: [webgisProvidePrivate]
};

// 用于注入
export const ComponentB = {
  mixins: [webgisInjectPrivate]
};
</script>
```

API 说明（注册与注入都可以访问这些 API）：

- `initWebgis(webgis)` 作为 webgis 初始化入口函数，例如上面的 `@init="initWebgis"
- `afterInitWebgis()` 用于在组件中执行 webgis 初始化之后的事件
- `$webgis` 初始化完成之后，该值即为 webgis 实例（该值不是响应式的，仅用与访问 webgis 实例）
- `webgisReady` 初始化完成状态，webgis 初始化后，该值等于 `true`（响应式的）

# 注意事项

- **不要将 map 实例放入 store 中，会出现最大溢出的错误，请使用依赖注入解决 map 实例对象在组件间交互。**
