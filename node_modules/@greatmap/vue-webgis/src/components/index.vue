<template>
  <transition v-if="show" name="webgis-transition-fade" mode="out-in">
    <keep-alive>
      <component
        @init="$emit('init', $event)"
        @init-split-screen="$emit('init-split-screen', $event)"
        :is="component"
      >
        <template v-if="$slots.aside" #aside>
          <slot name="aside"></slot>
        </template>
      </component>
    </keep-alive>
  </transition>
</template>

<script>
import { webgisPropsProvide } from '../mixins/webgis-props';
import WebGIS from './webgis/index';
import SplitScreen from './split-screen';
import eventHub from '../utils/event-hub';

/**
 * 中心组件（负责控制单屏/分屏的切换）
 */
export default {
  name: 'WebGISMain',
  mixins: [webgisPropsProvide],
  components: {
    WebGIS,
    SplitScreen
  },
  data: function() {
    return {
      show: true,
      splitScreenState: this.splitScreen
    };
  },
  computed: {
    component() {
      return this.splitScreenState ? SplitScreen : WebGIS;
    }
  },
  methods: {
    splitScreenToggle(state = !this.splitScreenState) {
      this.splitScreenState = state;
      this.$emit('splitScreenToggle', state);
    }
  },
  watch: {
    splitScreen(newVal) {
      this.splitScreenState = newVal;
    },
    'options.serviceCode'() {
      // 修改服务 ID 强制重新加载地图
      this.show = false;
      this.$nextTick(() => (this.show = true));
    }
  },
  created() {
    eventHub.$on('splitScreenToggle', this.splitScreenToggle);
  },
  beforeDestroy() {
    eventHub.$off('splitScreenToggle', this.splitScreenToggle);
  }
};
</script>
