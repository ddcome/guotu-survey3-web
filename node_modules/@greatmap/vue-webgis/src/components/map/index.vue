<template>
  <div class="webgis-map" ref="map"></div>
</template>

<script>
import GIS from '../../gis';
import { webgisProps } from '../../mixins/webgis-props';
import { errorMessage } from '../../utils/error-handler';
import promiseQueue from '../../utils/promise-queue';

/**
 * 地图组件（仅创建地图）
 */
export default {
  name: 'WebGISMap',
  mixins: [webgisProps],
  data() {
    return {
      requireModules: [
        'HistoryRecord',
        'FeatureSelect',
        'Measure',
        'LayerSwipe'
      ]
    };
  },
  computed: {
    webgisConfig() {
      return {
        ...this.options,
        target: this.$refs.map,
        modules: new Set([...this.modules, ...this.requireModules]),
        showControls: this.showControls,
        controls: this.controls
      };
    }
  },
  methods: {
    initMap() {
      // 防止同时执行多次
      this.$_initWebgisPromise = promiseQueue(this, () => {
        return GIS.create(this.webgisConfig)
          .then(
            (webgis) => {
              this.$webgis = webgis;
              this.$emit('init', webgis);
            },
            (error) => {
              this.$emit('init', false, error);
            }
          )
          .catch(errorMessage);
      });
    }
  },
  mounted() {
    this.initMap();
  },
  watch: {
    'options.showLayers': function(newVal) {
      this.$_initWebgisPromise.then(() => {
        const webgis = this.$webgis;
        webgis.clear();
        webgis.layerChange(newVal);
      });
    },
    showControls: function() {
      this.$_initWebgisPromise.then(() => {
        this.$webgis.toggleControls(this.showControls, this.controls);
      });
    }
  }
};
</script>

<style lang="scss" scoped>
.webgis-map {
  height: 100%;
  background: #f2f2f2;
}
</style>
