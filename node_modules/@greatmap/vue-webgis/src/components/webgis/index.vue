<template>
  <div class="webgis-container" v-loading="!webgisReady">
    <!-- map -->
    <Map
      :modules="webgisConfig.modules"
      :options="webgisConfig.options"
      :show-controls="webgisConfig.showControls"
      :controls="webgisConfig.controls"
      @init="initWebgis"
    />

    <!-- slot -->
    <div v-if="$slots.aside" class="webgis-slot">
      <slot name="aside"></slot>
    </div>

    <!-- aside -->
    <div class="webgis-aside-wrapper">
      <transition name="webgis-transition-slide">
        <Aside v-if="webgisConfig.showAside" />
      </transition>
    </div>

    <!-- main -->
    <div class="webgis-main">
      <!-- controls -->
      <transition name="webgis-transition-fade">
        <keep-alive>
          <Controls v-if="webgisConfig.showControls && $webgis" />
        </keep-alive>
      </transition>
    </div>

    <!-- rolling-screen -->
    <RollingScreen
      @input="rollingScreenChange"
      :type="rollingScreen.type"
      :value="rollingScreen.value"
      v-if="rollingScreen.active"
    />

    <!-- modals -->
    <Modals />
  </div>
</template>

<script>
import Map from '../map';
import Aside from './aside';
import Controls from './controls';
import Modals from '../modals';
import RollingScreen from './rolling-screen';
import { webgisProvide } from '../../mixins/webgis-init';
import { webgisPropsInject } from '../../mixins/webgis-props';
import { privateEventHubProvide } from '../../mixins/private-event-hub';

/**
 * 默认的地图组件（单屏）
 * **privateEventHubProvide 用于子组件之间事件共享，不要去掉**
 */
export default {
  name: 'WebGIS',
  mixins: [webgisProvide, webgisPropsInject, privateEventHubProvide],
  components: {
    Map,
    Aside,
    Controls,
    Modals,
    RollingScreen
  },
  data() {
    return {
      showAside: false,
      rollingScreen: {
        active: false,
        type: 'vertical', // vertical/horizontal
        value: 50
      }
    };
  },
  methods: {
    toggleAside(state = !this.webgisConfig.showAside) {
      this.webgisConfig.showAside = state;
    },
    rollingScreenToggleActive(
      state = !this.rollingScreen.active,
      type = 'vertical'
    ) {
      this.rollingScreen.active = state;
      this.rollingScreen.type = type;
      if (state) {
        this.rollingScreenChange();
      }
    },
    afterInitWebgis() {
      this.$eventHub.$on(
        'rollingScreenToggleActive',
        this.rollingScreenToggleActive
      );
      this.$eventHub.$on('clear', () => this.rollingScreenToggleActive(false));
    },
    rollingScreenChange(value = this.rollingScreen.value) {
      this.rollingScreen.value = value;
      this.$webgis.modules.layerSwipe.changeValue(value);
    }
  },
  activated() {
    this.$webgis && this.$webgis.updateSize();
  },
  mounted() {
    this.$eventHub.$on('toggleAside', this.toggleAside);
  },
  beforeDestroy() {
    this.$eventHub.$off('toggleAside', this.toggleAside);
    this.$eventHub.$off(
      'rollingScreenToggleActive',
      this.rollingScreenToggleActive
    );
  }
};
</script>

<style lang="scss" scoped>
@import '../../styles/common-variables';

.webgis-container {
  position: relative;
  overflow: hidden;
  height: 100%;
  display: flex;
}

// 底层
.webgis-map {
  position: absolute;
  width: 100%;
  height: 100%;
}

// 覆盖层
.webgis-slot,
.webgis-aside {
  position: relative;
  flex: none;
}

// 覆盖层
.webgis-main {
  position: relative;
  height: 0;
  flex: 1;
}
</style>
