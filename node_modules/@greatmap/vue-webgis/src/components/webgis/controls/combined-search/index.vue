<template>
  <div class="webgis-combined-search" v-loading="loading">
    <div class="webgis-combined-search__layer webgis-combined-search__block">
      <label>图层：</label>
      <ElSelectTree
        v-model="layer"
        placeholder="请选择图层"
        :popover-min-width="174"
        :props="treeNodesProps"
        :data="treeNodes"
        @change="layerChange"
      />
    </div>
    <div class="webgis-combined-search__field webgis-combined-search__block">
      <label>字段：</label>
      <CombinedSearchList
        v-model="field"
        :data="fieldData"
        @change="fieldChange"
      />
    </div>
    <div class="webgis-combined-search__value webgis-combined-search__block">
      <CombinedSearchKeyboard @input="updateSQLWhere" />
      <div class="webgis-combined-search__value-list-wrap">
        <CombinedSearchList
          v-model="value"
          height="104px"
          :keyword="valueKeyword"
          :data="valueData"
          @change="valueChange"
        />
        <div class="webgis-combined-search__value-filter">
          <label>查找：</label>
          <el-input
            clearable
            size="mini"
            v-model="valueKeyword"
            placeholder="关键字"
          ></el-input>
        </div>
      </div>
    </div>
    <div class="webgis-combined-search__where webgis-combined-search__block">
      <label>SELECT * FROM {{ selectedLayer.letter || '[LAYER]' }} WHERE</label>
      <el-input
        v-model="SQLWhere"
        resize="none"
        size="mini"
        type="textarea"
      ></el-input>
    </div>
    <div class="webgis-combined-search__btn webgis-combined-search__block">
      <el-button @click="reset()" size="mini" :disabled="!SQLWhere"
        >重置</el-button
      >
      <el-button @click="checkSQLWhere()" size="mini" :disabled="!checkParams"
        >校验</el-button
      >
      <el-button
        @click="enter()"
        type="primary"
        :disabled="!checkParams"
        size="mini"
        >确认</el-button
      >
      <el-button @click="close()" size="mini">关闭</el-button>
    </div>
  </div>
</template>

<script>
import ElSelectTree from 'el-select-tree';

import { checkValidArray } from '../../../../utils/check-array';
import CombinedSearchList from './list';
import CombinedSearchKeyboard from './keyboard';
import { webgisInject } from '../../../../mixins/webgis-init';

export default {
  name: 'WebGISCombinedSearch',
  mixins: [webgisInject],
  components: {
    ElSelectTree,
    CombinedSearchList,
    CombinedSearchKeyboard
  },
  data() {
    return {
      loading: false,
      layer: '',
      field: '',
      value: '',
      valueKeyword: '',
      SQLWhere: '',
      treeNodes: [],
      treeNodesProps: {
        value: 'id',
        label: 'name',
        children: 'children'
      },
      fieldData: [],
      valueData: []
    };
  },
  computed: {
    selectedLayer() {
      return (
        this.$webgis.treeLayers.find((item) => item.id === this.layer) || {}
      );
    },
    checkParams() {
      return this.layer && this.SQLWhere;
    }
  },
  methods: {
    afterInitWebgis() {
      this.treeNodes = this.$webgis.treeNodes;
    },
    layerChange(layer) {
      this.field = '';
      this.value = '';
      this.valueData = [];
      this.loading = true;
      this.$webgis
        .getLayerField(layer)
        .then((res) => (this.fieldData = res))
        .finally(() => (this.loading = false));
    },
    fieldChange(field) {
      this.updateSQLWhere(field);
      this.value = '';
      this.loading = true;
      this.$webgis
        .getLayerFieldValue(this.layer, field)
        .then((res) => (this.valueData = res))
        .finally(() => (this.loading = false));
    },
    valueChange(value) {
      this.updateSQLWhere(value);
    },
    updateSQLWhere(text) {
      this.SQLWhere += (this.SQLWhere ? ' ' : '') + text;
    },
    reset() {
      this.layer = '';
      this.field = '';
      this.fieldData = [];
      this.value = '';
      this.valueData = [];
      this.valueKeyword = '';
      this.SQLWhere = '';
    },
    checkSQLWhere() {
      this.loading = true;
      this.$webgis
        .getLayerInfo(
          this.$webgis.getLayerInfoParams(this.layer, {
            where: this.SQLWhere
          })
        )
        .then(
          () => this.$message.success('校验成功！'),
          () => this.$message.error('校验失败！')
        )
        .finally(() => (this.loading = false));
    },
    enter() {
      this.loading = true;
      return this.$webgis
        .searchFeature({
          where: this.SQLWhere,
          layerIds: [this.layer]
        })
        .then(
          ({ features, data }) => {
            if (checkValidArray(features) && checkValidArray(data)) {
              this.$webgis.modules.featureSelect.updateFeatures(features);
              this.$eventHub.$emit('changeModal', 'attribute-info', data);
            } else {
              this.$message.info('暂无数据');
              this.$eventHub.$emit('changeModal');
            }
          },
          () => this.$message.error('获取数据失败！')
        )
        .finally(() => (this.loading = false));
    },
    close() {
      this.$emit('close');
    }
  }
};
</script>

<style lang="scss" scoped>
@import '../../../../styles/common-variables';

.webgis-combined-search {
  font-size: $font-size-extra-small;
  &__block {
    margin-bottom: $spacing-base;
    &:last-of-type {
      margin-bottom: 0;
    }
  }
  &__layer {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  &__field {
    .webgis-combined-search-list {
      margin-top: $spacing-base;
    }
  }
  &__value {
    display: flex;
  }

  &__value-list-wrap {
    flex: 1;
    overflow: hidden;
  }
  &__value-filter {
    margin-top: $spacing-base/1.5;
    display: flex;
    align-items: center;
    .el-input {
      flex: 1;
    }
  }
  &__where {
    text-align: left;
    .el-textarea {
      margin-top: $spacing-base/4;
    }
  }
  &__btn {
    margin-bottom: 0;
    text-align: right;
    .el-button {
      padding: 6px 10px;
      text-align: center;
    }
  }
}
</style>
