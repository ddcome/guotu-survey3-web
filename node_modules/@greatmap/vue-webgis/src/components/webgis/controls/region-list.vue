<template>
  <ul class="webgis-region-list webgis-list-unstyled webgis-scrollbar-default">
    <li
      class="webgis-region-list_item"
      v-for="city in jurisdictionTreeData"
      :key="city.id"
    >
      <div class="webgis-region-list_item-left">
        <el-button @click="targetToView(city.id)" type="text"
          >{{ city.name }}：</el-button
        >
      </div>
      <ul class="webgis-region-list_item-right webgis-list-unstyled">
        <li
          class="webgis-region-list_item-right-item"
          v-for="area in city.children"
          :key="area.id"
        >
          <el-button @click="targetToView(area.id)" type="text">{{
            area.name
          }}</el-button>
        </li>
      </ul>
    </li>
    <li
      class="webgis-region-list_item__empty"
      v-if="!jurisdictionTreeData.length"
    >
      暂无数据
    </li>
  </ul>
</template>

<script>
import { webgisInject } from '../../../mixins/webgis-init';
import { webgisPropsInject } from '../../../mixins/webgis-props';
import { warnMessage } from '../../../utils/error-handler';
import { checkValidArray } from '../../../utils/check-array';

const regionListFeatureHash = {};

export default {
  name: 'WebGISRegionList',
  mixins: [webgisInject, webgisPropsInject],
  computed: {
    jurisdictionTreeData() {
      return this.webgisConfig.options.jurisdictionTreeData || [];
    }
  },
  methods: {
    targetToView(id) {
      const feature = regionListFeatureHash[id];
      if (feature) {
        this.$webgis.focusFeature(feature);
        setTimeout(() => {
          this.$webgis.removeFeature(feature);
        }, 1500);
      } else {
        warnMessage('未获取到要素');
      }
    },
    afterInitWebgis() {
      const webgis = this.$webgis;
      const treeLayers = webgis.treeLayers;
      if (checkValidArray(treeLayers)) {
        const layer = treeLayers.slice(-1)[0];
        const { config, configGroup } = layer;
        webgis
          .getLayerInfo({
            serviceCode: config.serviceCode,
            layerId: config.serverId,
            epsgNum: configGroup.wkid,
            extent: configGroup.extent
          })
          .then((res) => {
            this.$webgis.formatEsriJSON.readFeatures(res).map((item) => {
              const properties = item.getProperties();
              const key = properties.XZQDM || properties.DJQDM;
              if (key) {
                regionListFeatureHash[key] = item;
              }
            });
            return regionListFeatureHash;
          });
      }
    }
  }
};
</script>

<style lang="scss" scoped>
@import '../../../styles/common-variables';

.webgis-region-list {
  width: 300px;
  max-height: 380px;
  overflow-y: auto;
  &_item {
    display: flex;
    margin-bottom: $spacing-base;
    .el-button {
      padding: 0;
    }
    &-left {
      flex: none;
      width: 60px;
      margin-right: $spacing-base;
      .el-button {
        font-weight: bold;
        font-size: $font-size-small;
        white-space: normal;
        width: 100%;
        line-height: 1.3;
        text-align: left;
      }
    }
    &-right {
      display: flex;
      flex-wrap: wrap;
    }
    &-right-item {
      margin: 0 $spacing-base/2 $spacing-base/2 0;
    }
    &__empty {
      text-align: center;
      padding: $spacing-large;
      color: $color-text-secondary;
    }
  }
}
</style>
