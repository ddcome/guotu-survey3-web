<template>
  <div class="webgis-top-search webgis-absolute-layer">
    <div class="webgis-top-search__left webgis-box-shadow-default">
      <el-input
        :disabled="loading"
        size="small"
        v-model="keyword"
        clearable
        placeholder="请输入关键字"
        @keyup.enter.native="search"
      ></el-input>
      <el-button
        :disabled="loading"
        @click="search"
        size="small"
        type="primary"
        :icon="searchIcon"
      ></el-button>
    </div>
    <el-popover
      v-model="combinedSearchVisible"
      placement="bottom-end"
      width="270"
    >
      <CombinedSearch @close="combinedSearchVisible = false" />
      <el-button
        slot="reference"
        class="webgis-box-shadow-default"
        size="small"
      >
        组合查询
      </el-button>
    </el-popover>
  </div>
</template>

<script>
import { webgisInject } from '../../../mixins/webgis-init';
import { webgisPropsInject } from '../../../mixins/webgis-props';
import { checkValidArray } from '../../../utils/check-array';
import CombinedSearch from './combined-search/index';

export default {
  name: 'WebGISTopSearch',
  mixins: [webgisInject, webgisPropsInject],
  components: {
    CombinedSearch
  },
  data() {
    return {
      loading: false,
      keyword: '',
      combinedSearchVisible: false
    };
  },
  computed: {
    keywordSQL() {
      const fields = this.searchRange.fields || [];
      return fields
        .map((item) => `${item} LIKE '%${this.keyword}%'`)
        .join(' OR ');
    },
    searchRange() {
      return this.webgisConfig.options.searchRange || {};
    },
    searchIcon() {
      return `el-icon-${this.loading ? 'loading' : 'search'}`;
    }
  },
  methods: {
    search() {
      this.loading = true;
      this.$webgis
        .searchFeature({
          where: this.keywordSQL,
          layerIds: this.searchRange.layers || []
        })
        .then(({ features, data }) => {
          if (checkValidArray(features) && checkValidArray(data)) {
            this.$webgis.modules.featureSelect.updateFeatures(features);
            this.$eventHub.$emit('changeModal', 'attribute-info', data);
          } else {
            this.$message.info('暂无数据');
            this.$eventHub.$emit('changeModal');
          }
        })
        .finally(() => (this.loading = false));
    }
  }
};
</script>

<style lang="scss">
.webgis-top-search input {
  border-radius: 0;
  border: 0;
}
</style>

<style lang="scss" scoped>
@import '../../../styles/common-variables';

.webgis-top-search {
  display: flex;
  top: 10px;
  left: 10px;
  &__left {
    margin-right: $spacing-medium;
  }
  .el-input {
    width: 180px;
  }
  .el-button {
    border-radius: 0;
    border: 0;
    height: 32px;
    vertical-align: top;
  }
}
</style>
