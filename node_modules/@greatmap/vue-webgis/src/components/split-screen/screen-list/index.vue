<template>
  <div class="webgis-screen-list">
    <el-row
      v-for="(data, index1) in splitScreenData"
      :key="index1"
      :gutter="10"
      :style="{ height: currentScreenPlan.height }"
      class="webgis-screen-list__row"
    >
      <el-col
        class="webgis-screen-list__col"
        :span="item.span"
        :key="item.id"
        v-for="item in data"
      >
        <ScreenListItem @init="webgisInit(item.id, $event)" :data="item" />
      </el-col>
    </el-row>
  </div>
</template>

<script>
import chunk from 'lodash/chunk';

import screenPlan from '../screen-plan';
import ScreenListItem from './list-item';

export default {
  name: 'WebGISSplitScreenList',
  components: {
    ScreenListItem
  },
  props: {
    screenData: Array
  },
  data: function() {
    return {
      webgisList: {}
    };
  },
  computed: {
    splitScreenData() {
      const spans = this.currentScreenPlan.spans;
      if (spans) {
        const data = this.screenActivedData;
        data.forEach((item, index) => {
          item.span = spans[index];
        });
        return chunk(data, data.length >= 5 ? 3 : 2);
      } else {
        return [];
      }
    },
    screenActivedData() {
      return this.screenData.filter((item) => item.show);
    },
    currentScreenPlan() {
      return screenPlan[this.screenActivedData.length] || {};
    }
  },
  methods: {
    /**
     * webgis 初始化
     * @description
     * 在分屏列表全部加载完毕时，向上级触发 `webgisReady` 事件。
     */
    webgisInit(id, webgis) {
      if (webgis) {
        this.webgisList[id] = webgis;
        const allReadyState = !this.screenActivedData.find(
          (item) => !this.webgisList[item.id]
        );
        if (allReadyState) {
          this.$emit('webgisReady', this.webgisList);
        }
        // 绑定移动缩放事件，同步所有的分屏
        if (!webgis._bindMoveend) {
          webgis._bindMoveend = webgis.olMap.on('moveend', () => {
            webgis.interactions.zoom.syncMapsMove(
              Object.values(this.webgisList).filter(
                (item) => item.id !== webgis.id
              )
            );
          });
        }
      }
    },
    updateSize() {
      this.$nextTick(function() {
        this.screenActivedData.forEach((data) => {
          const webgis = this.webgisList[data.id];
          webgis && webgis.updateSize();
        });
      });
    }
  },
  watch: {
    // 监听激活的分屏列表，更新 webgisList 与 updateSize
    screenActivedData(newVal) {
      const webgisList = this.webgisList;
      // 释放内存
      Object.keys(webgisList).forEach((key) => {
        if (!newVal.find((item) => item.id === +key)) {
          delete webgisList[key];
        }
      });
      this.updateSize();
    }
  }
};
</script>

<style lang="scss" scoped>
@import '../../../styles/common-variables';

.webgis-screen-list {
  height: 100%;
  &__row {
    padding-bottom: $spacing-base;
  }
  &__col {
    height: 100%;
  }
}
</style>
