<template>
  <div class="webgis-split-screen">
    <ScreenList
      ref="screenList"
      @webgisReady="webgisReady"
      :screen-data="screenData"
      class="webgis-split-screen__content"
    />
    <ScreenSetting
      :screen-data="screenData"
      :layer-tree="layerTree"
      @changeScreenLayer="changeScreenLayer"
      @changeScreenLen="changeScreenLen"
      @changeScreenActive="changeScreenActive"
      class="webgis-split-screen__setting"
    />
  </div>
</template>

<script>
import ScreenList from './screen-list';
import ScreenSetting from './screen-setting';

/**
 * 分屏组件
 */
export default {
  name: 'WebGISSplitScreen',
  components: {
    ScreenList,
    ScreenSetting
  },
  data() {
    return {
      screenData: [
        {
          id: 0,
          show: true,
          layer: {}
        }
      ],
      layerData: [],
      layerTree: []
    };
  },
  methods: {
    // 修改分屏的数量
    changeScreenLen(number) {
      const data = this.screenData;
      while (number < data.length) {
        this.screenData.pop();
      }

      while (number > data.length) {
        data.push({
          id: data.length,
          show: true,
          layer: {}
        });
      }
    },
    // 切换分屏的激活状态
    changeScreenActive(index) {
      this.screenData[index].show = !this.screenData[index].show;
    },
    // 修改分屏的专题
    changeScreenLayer(index, id) {
      this.screenData[index].layer = this.layerData.find(
        (item) => item.id === id
      );
    },
    // webgis ready 事件
    webgisReady(webgisList) {
      // 取第一个图层数据即可
      if (!this.layerData.length) {
        const webgis = webgisList[this.screenData[0].id];
        this.layerTree = webgis.treeNodes;
        this.layerData = webgis.treeLayers;
      }

      // 向上级发送分屏加载完毕
      this.$emit(
        'init-split-screen',
        this.screenData.map((item) => ({
          ...item,
          webgis: webgisList[item.id]
        }))
      );
    }
  },
  activated() {
    this.$refs.screenList.updateSize();
  }
};
</script>

<style lang="scss" scoped>
@import '../../styles/common-variables';

.webgis-split-screen {
  display: flex;
  position: absolute;
  width: 100%;
  height: 100%;
  padding: $spacing-base $spacing-base 0;
  align-items: flex-start;
  &__content {
    flex: 1;
  }
  &__setting {
    margin-left: $spacing-base;
    margin-bottom: $spacing-base;
    width: 260px;
  }
}
</style>
