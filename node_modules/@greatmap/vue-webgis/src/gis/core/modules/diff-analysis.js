import { createOverlayAnalysis } from '../../api/modules/diff-analysis';
import {
  createAnalysisService,
  getAnalysisResult
} from '../../api/analysis-service';
import BaseAnalysis from '../common/base-analysis';

export default class DiffAnalysis extends BaseAnalysis {
  constructor(map) {
    super(map);
  }

  /**
   * 执行分析
   *
   * @param {String} inputServiceCode 输入图层服务名
   * @param {String} [inputFilter] 输入图层过滤值
   * @param {String} overlayServiceCode 叠加图层服务名
   * @param {String} [overlayFilter] 叠加图层过滤值
   *
   * @return {Promise}
   */
  doAnalysis({
    inputServiceCode,
    inputFilter,
    overlayServiceCode,
    overlayFilter
  }) {
    const serviceName = 'diffAnalysis_overlay_' + Date.now();

    return createAnalysisService(serviceName).then((res) => {
      return createOverlayAnalysis({
        serviceUrl: res.serviceurl,
        serviceId: res.itemId,
        name: serviceName,
        inputServiceCode,
        inputFilter,
        overlayServiceCode,
        overlayFilter
      }).then((res) => {
        return this.getProgress('OverlayLayers', res.jobId).then(() => {
          return getAnalysisResult(serviceName, this._wkid).then((res) => {
            this._map.interactions.zoom.toFeatures(
              this._map.renderFeatureData(res)
            );
            return res;
          });
        });
      });
    });
  }
}
