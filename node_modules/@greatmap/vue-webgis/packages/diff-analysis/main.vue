<template>
  <div class="webgis-diff-analysis">
    <div
      class="webgis-diff-analysis__block webgis-diff-analysis__block_left"
      v-show="showResult"
    >
      <div v-show="showResult" class="webgis-diff-analysis__item">
        <h4 class="webgis-diff-analysis__name webgis-box-shadow-base">
          分析结果
        </h4>
        <WebGISMap
          @init="initWebgis"
          :options="{ showLayers: webgisGroupPrivate.item1.id }"
          :show-controls="false"
          :modules="['DiffAnalysis']"
        />
      </div>
    </div>
    <div
      class="webgis-diff-analysis__block webgis-diff-analysis__block_right"
      :class="{ 'flex-column': showResult }"
    >
      <div
        v-for="(item, key) in webgisGroupPrivate"
        :key="key"
        class="webgis-diff-analysis__item"
      >
        <h4 class="webgis-diff-analysis__name webgis-box-shadow-base">
          {{ item.name }}
        </h4>
        <WebGISMap
          @init="webgisGroupInit(key, $event)"
          :options="{ showLayers: item.id }"
          :show-controls="false"
        />
      </div>
    </div>
  </div>
</template>

<script>
import WebGISMap from '../../src/components/map/index';
import { errorMessage } from '../../src/utils/error-handler';

/**
 * 差异分析组件
 *
 * @prop {{id, name}[]} webgisGroup 待分析的地图列表，example: [{ id: "X620102DC2019GDLTB", name: "城关区2019地类图斑" }]
 *
 * @event webgisGroupInit(index, webgis) webgis 列表有地图完成了初始化
 * @event webgisResultInit(webgis) 展示结果的地图完成了初始化
 *
 * @method doAnalysis() 开始分析，返回 Promise 分析结果状态
 * @method updateFeature(index, features) 更新地图的 feature
 */
export default {
  components: {
    WebGISMap
  },
  props: {
    /**
     * webgis 待分析的地图列表
     * @example: [{ id: "X620102DC2019GDLTB", name: "城关区2019地类图斑" }]
     * @property {string} id 图层的 id
     * @property {string} name 地图的名称
     */
    webgisGroup: {
      type: Object,
      default() {
        return {};
      }
    }
  },
  data() {
    return {
      showResult: false,
      // webgis 实例集合
      webgis: {
        item1: null,
        item2: null
      },
      webgisResult: null
    };
  },
  computed: {
    // 收集所有的 webgis
    allWebgis() {
      const webgis = this.webgis;
      return [webgis.item1, webgis.item2, this.webgisResult].filter(
        (item) => item
      );
    },

    // 有效的 webgisGroup
    webgisGroupPrivate() {
      const webgisGroup = this.webgisGroup;
      const result = {};
      let value;
      for (const key in webgisGroup) {
        if (webgisGroup.hasOwnProperty(key)) {
          value = webgisGroup[key];
          if (value) {
            result[key] = value;
          }
        }
      }
      return result;
    }
  },
  methods: {
    // 开始分析，返回 Promise 分析结果状态
    doAnalysis() {
      const item1 = this.webgisGroup.item1;
      const item2 = this.webgisGroup.item2;
      if (item1.id && item2.id) {
        const params = {
          inputServiceCode: item1.id,
          overlayServiceCode: item2.id
        };
        if (item1.field && item1.fieldValue) {
          params.inputFilter = `${item1.field} = '${item1.fieldValue}'`;
        }
        if (item2.field && item2.fieldValue) {
          params.overlayFilter = `${item2.field} = '${item2.fieldValue}'`;
        }

        return this.webgisResult.modules.diffAnalysis
          .doAnalysis(params)
          .then((res) => {
            this.showResult = true;
            this.updateSize();
            return res;
          });
      } else {
        const error = '对比分析：参数不全';
        errorMessage(error);
        return Promise.reject(error);
      }
    },

    /**
     * 更新地图的 feature
     * @param {String} name webgis 名称 item1/2
     * @param {FeatureLike[]} features example:{ features: [], attributes: [] }
     */
    updateFeature(name, features) {
      const webgis = this.webgis[name];
      webgis.renderFeatureData(features);
    },

    // 分析结果的 webgis 初始化
    initWebgis(webgis) {
      this.webgisResult = webgis;
      this.$emit('webgisResultInit', webgis);
      this.bindMoveend(webgis);
      this.updateSize();
      webgis.setLayerOpacity(this.webgisGroup.item1.id, 0);
    },

    // 其他选择图层的 webgis 初始化
    webgisGroupInit(key, webgis) {
      this.webgis[key] = webgis;
      this.$emit('webgisGroupInit', key, webgis);
      this.bindMoveend(webgis);
      this.updateSize();
    },

    // 更新每一个屏的地图
    updateSize() {
      this.$nextTick(() => {
        // 重置视图
        this.webgis.item1 && this.webgis.item1.interactions.zoom.resetView();

        // resize
        this.allWebgis.forEach((item) => item.olMap.updateSize());
      });
    },

    // 绑定移动缩放事件，同步所有的分屏
    bindMoveend(webgis) {
      if (!webgis._bindMoveend) {
        webgis._bindMoveend = true;
        webgis.olMap.on('moveend', () => {
          webgis.interactions.zoom.syncMapsMove(
            this.allWebgis.filter((item) => webgis.id !== item.id)
          );
        });
      }
    },

    // 与 webgisGroup 同步，多余删除
    syncWebgisList() {
      const webgis = this.webgis;

      if (!this.webgisGroup.item1) webgis.item1 = null;
      if (!this.webgisGroup.item2) webgis.item2 = null;

      if (this.webgisGroup.length !== 2) {
        this.showResult = false;
      }
    }
  },
  watch: {
    webgisGroup() {
      this.updateSize();
      this.syncWebgisList();
    },
    'webgisGroup.item1'() {
      // 重置视图
      this.webgis.item1.interactions.zoom.resetView();
    }
  }
};
</script>

<style lang="scss" scoped>
@import '../../src/styles/common-variables';

.webgis-diff-analysis {
  height: 100%;
  display: flex;
  &__block {
    height: 100%;
    flex: 1;
    &_left {
      border-right: $border-base;
      .webgis-diff-analysis__item {
        height: 100%;
      }
    }
    &_right {
      display: flex;
      &.flex-column {
        flex-direction: column;
        > .webgis-diff-analysis__item {
          height: 50%;
          &:first-of-type {
            border-bottom: $border-base;
          }
          &:nth-child(2) {
            border-left: 0;
          }
        }
      }
      > .webgis-diff-analysis__item {
        flex: 1;
        &:nth-child(2) {
          border-left: $border-base;
        }
      }
    }
  }
  &__item {
    position: relative;
  }
  &__name {
    font-size: $font-size-small;
    position: absolute;
    top: $spacing-base;
    right: $spacing-base;
    padding: 6px 8px;
    background: white;
    z-index: 1;
  }
}
</style>
